<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Fisioterapia (Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.6); }
        .appointment-cell {
            position: relative; color: #1f2937; cursor: pointer;
            transition: filter 0.2s; overflow: hidden; text-overflow: ellipsis;
            white-space: normal; text-align: left; vertical-align: top; border-radius: 4px;
        }
        .appointment-cell:hover { filter: brightness(1.1); }
        #calendarTable th, #calendarTable td { border: 1px solid #e5e7eb; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #78716c; }
        .sync-status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .sync-offline { background-color: #f87171; } /* red-400 */
        .sync-online { background-color: #fbbf24; } /* amber-400 */
        .sync-synced { background-color: #4ade80; } /* green-400 */

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body::before {
                content: attr(data-print-title);
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 16pt;
                font-weight: bold;
                padding-top: 10mm;
                padding-bottom: 10mm;
            }
            header, 
            #patientSidebar,
            #addPatientBtn,
            #prevWeekBtn,
            #nextWeekBtn,
            #todayBtn,
            #printWeekBtn,
            #patientModal,
            #appointmentModal,
            #confirmActionModal,
            #confirmRecurrenceModal {
                display: none !important;
            }

            .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .main-content { width: 100% !important; }
            #calendar-wrapper { overflow: visible !important; margin-top: 40px; }
            #calendarTable { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #calendarTable th, #calendarTable td { border: 1px solid #ccc !important; padding: 4px; }
            .appointment-cell { color: #000 !important; }
            .bg-white { box-shadow: none !important; border: none !important; padding: 0 !important; }
            #weeklyTotal { margin-top: 20px; text-align: right; }

            @page {
                size: A4 landscape;
                margin: 15mm;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Sidebar Backdrop -->
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>

    <div class="container mx-auto p-2 sm:p-4 lg:p-6">
        <header class="mb-6 pb-4 border-b border-gray-300">
            <div class="flex justify-between items-start">
                <div class="flex items-center space-x-4">
                    <button id="togglePatientListBtn" class="p-2 rounded-md hover:bg-gray-200 lg:hidden">
                        <i class="fas fa-bars fa-lg text-gray-600"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-teal-700">Gestionale Fisioterapia</h1>
                         <div id="auth-container" class="mt-2">
                            <button id="authorize_button" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow hidden">
                                <i class="fab fa-google mr-2"></i> Accedi con Google per Sincronizzare
                            </button>
                            <div id="user_info" class="hidden items-center space-x-2 text-sm">
                                <span id="user_name" class="font-semibold"></span>
                                <button id="signout_button" class="text-red-500 hover:underline">(esci)</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="sync-status" class="flex items-center space-x-2 text-sm text-gray-600">
                    <div id="sync-status-dot" class="sync-status-dot sync-offline"></div>
                    <span id="sync-status-text">Offline</span>
                </div>
            </div>
        </header>

        <div class="relative flex lg:space-x-6">
            <!-- Patient Sidebar -->
            <div id="patientSidebar" class="fixed top-0 left-0 h-full w-4/5 max-w-sm bg-gray-50 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:w-1/3 xl:w-1/4">
                 <div class="bg-white p-4 rounded-lg shadow-md self-start h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-700">Pazienti</h2>
                        <button id="addPatientBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center">
                            <i class="fas fa-plus mr-2"></i> Nuovo
                        </button>
                    </div>
                    <div id="patientList" class="space-y-2 overflow-y-auto flex-grow custom-scrollbar"></div>
                </div>
            </div>

            <!-- Main Content: Calendar -->
            <div class="w-full main-content">
                <div class="bg-white p-3 sm:p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 space-y-4 sm:space-y-0">
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button id="prevWeekBtn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="weekRange" class="text-base sm:text-xl font-bold text-gray-700 text-center w-40 sm:w-64"></h2>
                            <button id="nextWeekBtn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                            <button id="todayBtn" class="ml-2 sm:ml-4 px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">Oggi</button>
                            <button id="printWeekBtn" class="ml-2 px-3 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md flex items-center">
                                <i class="fas fa-print mr-2"></i> Stampa
                            </button>
                        </div>
                        <div id="weeklyTotal" class="text-right bg-green-50 p-2 rounded-md">
                            <p class="text-sm text-gray-500">Guadagno Settimana</p>
                            <p class="text-xl sm:text-2xl font-bold text-green-600">€ 0.00</p>
                        </div>
                    </div>
                    <div id="calendar-wrapper" class="overflow-x-auto custom-scrollbar">
                        <table id="calendarTable" class="w-full min-w-[700px] border-collapse text-center">
                            <thead id="calendarHead"></thead>
                            <tbody id="calendarBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="patientModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md m-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="patientModalTitle" class="text-2xl font-bold"></h2>
                <button type="button" id="deletePatientBtn" class="text-red-500 hover:text-red-700 hidden" title="Elimina Paziente">
                    <i class="fas fa-trash-alt fa-lg"></i>
                </button>
            </div>
            <form id="patientForm">
                <input type="hidden" id="patientId">
                <div class="space-y-4">
                    <input id="patientName" type="text" placeholder="Nome" class="w-full px-4 py-2 border rounded-lg" required>
                    <input id="patientSurname" type="text" placeholder="Cognome" class="w-full px-4 py-2 border rounded-lg" required>
                    <input id="patientPhone" type="tel" placeholder="Telefono" class="w-full px-4 py-2 border rounded-lg">
                    <textarea id="patientAddress" placeholder="Indirizzo" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                    <div>
                        <label for="patientDefaultPrice" class="block text-sm font-medium text-gray-700 mb-1">Prezzo Predefinito (€)</label>
                        <input id="patientDefaultPrice" type="number" step="0.01" placeholder="Es. 50.00" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <textarea id="patientNotes" placeholder="Note cliniche..." rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div class="flex flex-wrap justify-end mt-6 gap-3">
                    <button type="button" id="addAppointmentFromPatientBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hidden"><i class="fas fa-calendar-plus mr-2"></i>Crea App.</button>
                    <button type="button" id="cancelPatientBtn" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Annulla</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <div id="appointmentModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg m-4 overflow-y-auto max-h-[90vh]">
            <h2 id="appointmentModalTitle" class="text-2xl font-bold mb-4"></h2>
            <div id="conflictError" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
              <p class="font-bold">Conflitto Rilevato</p><p>L'orario si sovrappone con un altro appuntamento.</p>
            </div>
            <form id="appointmentForm">
                <input type="hidden" id="appointmentId"><input type="hidden" id="originalAppointmentData">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="appointmentPatient" class="block text-sm font-medium text-gray-700">Paziente</label>
                        <select id="appointmentPatient" class="w-full mt-1 px-4 py-2 border rounded-lg" required></select>
                    </div>
                    <div>
                        <label for="appointmentPrice" class="block text-sm font-medium text-gray-700">Prezzo (€)</label>
                        <input id="appointmentPrice" type="number" step="0.01" placeholder="Es. 50.00" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="appointmentDate" class="block text-sm font-medium text-gray-700">Data</label>
                        <input id="appointmentDate" type="date" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                             <label for="appointmentTime" class="block text-sm font-medium text-gray-700">Orario</label>
                            <input id="appointmentTime" type="time" step="900" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label for="appointmentDuration" class="block text-sm font-medium text-gray-700">Durata (min)</label>
                            <input id="appointmentDuration" type="number" min="15" step="15" value="60" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                        </div>
                    </div>
                </div>
                <div class="mt-4"><textarea id="appointmentNotes" placeholder="Note sulla seduta..." rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea></div>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="isRecurring" class="h-5 w-5 rounded text-teal-600 focus:ring-teal-500"><span class="font-medium">Appuntamento Ricorrente</span>
                    </label>
                    <div id="recurringOptions" class="hidden mt-3 space-y-3">
                        <div class="flex items-center space-x-2 sm:space-x-4"><label class="text-sm">Ripeti:</label>
                            <div id="weekdays" class="flex flex-wrap gap-1">
                                <label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="1" class="hidden"> L</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="2" class="hidden"> M</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="3" class="hidden"> M</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="4" class="hidden"> G</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="5" class="hidden"> V</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="6" class="hidden"> S</label><label class="p-2 border rounded-full text-xs cursor-pointer"><input type="checkbox" data-day="0" class="hidden"> D</label>
                            </div>
                        </div>
                        <div><label for="recurringWeeks" class="text-sm">Per <input id="recurringWeeks" type="number" min="1" value="12" class="w-16 mx-1 text-center border rounded-md"> settimane</label></div>
                    </div>
                </div>
                <div class="flex flex-wrap justify-end mt-6 gap-3">
                    <button type="button" id="cancelAppointmentBtn" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Annulla</button>
                    <button type="button" id="deleteAppointmentBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">Elimina</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmActionModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md m-4 text-center">
            <h2 id="confirmActionTitle" class="text-xl font-bold mb-4"></h2><p id="confirmActionMessage" class="mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirmActionCancel" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">Annulla</button>
                <button id="confirmActionOk" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Conferma</button>
            </div>
        </div>
    </div>

    <div id="confirmRecurrenceModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md m-4 text-center">
            <h2 id="confirmRecurrenceTitle" class="text-xl font-bold mb-4"></h2><p id="confirmRecurrenceMessage" class="mb-6"></p>
            <div class="flex flex-col space-y-3">
                <button id="confirmRecurrenceSingle" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg"></button>
                <button id="confirmRecurrenceAll" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg"></button>
                <button id="confirmRecurrenceCancel" class="w-full mt-4 bg-gray-300 hover:bg-gray-400 font-bold py-3 px-4 rounded-lg">Annulla</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>

    <script type="module">
        // #############################################################################
        // ### CONFIGURAZIONE - INCOLLA QUI LE TUE CHIAVI                           ###
        // #############################################################################
        const API_KEY = 'AIzaSyCyrvErd34wK8ryRN_7Ni4HHeHGsCUP-rI'
        const CLIENT_ID = '999092828800-342l4shrm85f00bdigvn8q78rkufh7fh.apps.googleusercontent.com'
        // #############################################################################

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DRIVE_FILENAME = 'gestionale-fisioterapia-data.json';
        const LOCAL_STORAGE_KEY = 'fisioterapia-gestionale-data-local';

        let tokenClient;
        let driveFileId = null;
        let state = { lastModified: 0, patients: [], appointments: [] };
        let currentWeekStartDate = getMonday(new Date());

        let ui;

        window.onload = function() {
            ui = {
                authorizeButton: document.getElementById('authorize_button'),
                signoutButton: document.getElementById('signout_button'),
                userInfoDiv: document.getElementById('user_info'),
                userNameSpan: document.getElementById('user_name'),
                syncStatusDot: document.getElementById('sync-status-dot'),
                syncStatusText: document.getElementById('sync-status-text'),
                patientListEl: document.getElementById('patientList'),
                calendarHead: document.getElementById('calendarHead'),
                calendarBody: document.getElementById('calendarBody'),
                patientModal: document.getElementById('patientModal'),
                appointmentModal: document.getElementById('appointmentModal'),
                confirmRecurrenceModal: document.getElementById('confirmRecurrenceModal'),
                confirmActionModal: document.getElementById('confirmActionModal'),
                patientForm: document.getElementById('patientForm'),
                appointmentForm: document.getElementById('appointmentForm'),
                patientIdInput: document.getElementById('patientId'),
                patientModalTitle: document.getElementById('patientModalTitle'),
                patientNameInput: document.getElementById('patientName'),
                patientSurnameInput: document.getElementById('patientSurname'),
                patientPhoneInput: document.getElementById('patientPhone'),
                patientAddressInput: document.getElementById('patientAddress'),
                patientDefaultPriceInput: document.getElementById('patientDefaultPrice'),
                patientNotesInput: document.getElementById('patientNotes'),
                appointmentModalTitle: document.getElementById('appointmentModalTitle'),
                appointmentIdInput: document.getElementById('appointmentId'),
                originalAppointmentDataInput: document.getElementById('originalAppointmentData'),
                appointmentPatientSelect: document.getElementById('appointmentPatient'),
                appointmentPriceInput: document.getElementById('appointmentPrice'),
                appointmentDateInput: document.getElementById('appointmentDate'),
                appointmentTimeInput: document.getElementById('appointmentTime'),
                appointmentDurationInput: document.getElementById('appointmentDuration'),
                appointmentNotesInput: document.getElementById('appointmentNotes'),
                conflictError: document.getElementById('conflictError'),
                deleteAppointmentBtn: document.getElementById('deleteAppointmentBtn'),
                deletePatientBtn: document.getElementById('deletePatientBtn'),
                printWeekBtn: document.getElementById('printWeekBtn'),
                togglePatientListBtn: document.getElementById('togglePatientListBtn'),
                patientSidebar: document.getElementById('patientSidebar'),
                sidebarBackdrop: document.getElementById('sidebarBackdrop'),
                recurringOptions: document.getElementById('recurringOptions'),
                isRecurringCheckbox: document.getElementById('isRecurring'),
                recurringWeeksInput: document.getElementById('recurringWeeks'),
                weekRange: document.getElementById('weekRange')
            };

            loadStateFromLocal();
            refreshUI();
            
            gapi.load('client', initializeGapiClient);
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = initializeGis;
            document.body.appendChild(script);

            setupEventListeners();
        };

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        }

        function initializeGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleTokenResponse,
                error_callback: handleGisError,
            });
            tokenClient.requestAccessToken({prompt: 'none'});
        }
        
        async function handleTokenResponse(resp) {
            if (resp.error) { return; }
            gapi.client.setToken(resp);
            updateSigninStatus(true);
            await syncWithDrive();
        }

        function handleGisError(error) {
            console.log('Silent login failed or user not logged in.', error);
            updateSigninStatus(false);
        }

        function handleAuthClick() {
            if (tokenClient) {
                 if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            } else {
                console.error("Google Token Client not initialized.");
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    updateSigninStatus(false);
                });
            }
        }

        function updateSigninStatus(isSignedIn) {
            ui.authorizeButton.classList.toggle('hidden', isSignedIn);
            ui.userInfoDiv.classList.toggle('hidden', !isSignedIn);
            
            if (isSignedIn) {
                 gapi.client.request({ path: 'https://www.googleapis.com/oauth2/v1/userinfo' })
                    .then(response => {
                        ui.userNameSpan.textContent = `Ciao, ${response.result.given_name}`;
                    });
            } else {
                ui.userNameSpan.textContent = '';
                driveFileId = null;
                updateSyncStatus('offline');
            }
        }

        async function findOrCreateDriveFile() {
            const response = await gapi.client.drive.files.list({
                q: `name='${DRIVE_FILENAME}' and trashed=false`,
                spaces: 'drive',
                fields: 'files(id, name, modifiedTime)',
            });
            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            }
            const createResponse = await gapi.client.drive.files.create({
                resource: { name: DRIVE_FILENAME, appProperties: {isPhysioApp: 'true'}, parents: ['root'] },
                fields: 'id',
            });
            return createResponse.result.id;
        }

        async function loadFromDrive(fileId) {
            try {
                const response = await gapi.client.drive.files.get({ fileId, alt: 'media' });
                return response.result;
            } catch (e) { console.error("Error loading from Drive:", e); return null; }
        }

        async function saveToDrive(fileId, content) {
            updateSyncStatus('online');
            const boundary = '-------314159265358979323846';
            const multipartRequestBody = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify({ name: DRIVE_FILENAME, mimeType: 'application/json' })}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(content)}\r\n--${boundary}--`;
            try {
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'multipart' },
                    headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` },
                    body: multipartRequestBody
                });
                updateSyncStatus('synced');
            } catch (error) { console.error("Error saving to Drive:", error); updateSyncStatus('offline'); }
        }
        
        async function syncWithDrive() {
            if (!gapi.client.getToken()) return;
            updateSyncStatus('online');
            if (!driveFileId) driveFileId = await findOrCreateDriveFile();
            const driveData = await loadFromDrive(driveFileId);
            const localData = getStateFromLocal();
            
            if (driveData && (!localData || driveData.lastModified > localData.lastModified)) {
                state = driveData;
            }
            state.lastModified = Date.now();
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            await saveToDrive(driveFileId, state);
            refreshUI();
        }

        function updateSyncStatus(status) {
            ui.syncStatusDot.className = 'sync-status-dot';
            const statuses = {
                offline: { class: 'sync-offline', text: 'Offline' },
                online: { class: 'sync-online', text: 'Sincronizzazione...' },
                synced: { class: 'sync-synced', text: 'Sincronizzato' }
            };
            ui.syncStatusDot.classList.add(statuses[status].class);
            ui.syncStatusText.textContent = statuses[status].text;
        }

        function loadStateFromLocal() {
            const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedState) state = JSON.parse(storedState);
        }
        
        function getStateFromLocal() {
             return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || { lastModified: 0, patients: [], appointments: [] };
        }

        function saveState() {
            state.lastModified = Date.now();
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            if (gapi.client.getToken() && driveFileId) {
                saveToDrive(driveFileId, state);
            }
        }
        
        function refreshUI() {
            renderPatientList();
            renderCalendar();
        }

        function getMonday(d) {
            d = new Date(d); const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0); return monday;
        }
        function addDays(date, days) {
            const result = new Date(date); result.setDate(result.getDate() + days); return result;
        }
        function formatDate(date, format = 'YYYY-MM-DD') {
            const d = new Date(date);
            const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0');
            if (format === 'YYYY-MM-DD') return `${year}-${month}-${day}`;
            if (format === 'DD/MM') return `${day}/${month}`;
            return d.toLocaleDateString('it-IT');
        }

        const PATIENT_COLORS = ['#a7f3d0', '#bae6fd', '#fbcfe8', '#fef08a', '#c7d2fe', '#d9f99d', '#fed7aa', '#e9d5ff', '#a5f3fc', '#fecaca', '#bbf7d0', '#bfdbfe', '#f5d0fe', '#fde68a', '#d1d5db', '#fde047'];
        function getPatientColor(patientId) {
            if (!patientId) return PATIENT_COLORS[14];
            let hash = 0;
            for (let i = 0; i < patientId.length; i++) { hash = patientId.charCodeAt(i) + ((hash << 5) - hash); }
            return PATIENT_COLORS[Math.abs(hash % PATIENT_COLORS.length)];
        }
        
        function openPatientModal(patient = null) {
            ui.patientForm.reset();
            const addAppointmentBtn = document.getElementById('addAppointmentFromPatientBtn');
            ui.patientIdInput.value = patient ? patient.id : '';
            ui.patientModalTitle.textContent = patient ? 'Modifica Paziente' : 'Nuovo Paziente';
            
            if(patient) {
                ui.patientNameInput.value = patient.name;
                ui.patientSurnameInput.value = patient.surname;
                ui.patientPhoneInput.value = patient.phone || '';
                ui.patientAddressInput.value = patient.address || '';
                ui.patientDefaultPriceInput.value = patient.defaultPrice || '';
                ui.patientNotesInput.value = patient.notes || '';
                addAppointmentBtn.classList.remove('hidden');
                ui.deletePatientBtn.classList.remove('hidden');
            } else {
                addAppointmentBtn.classList.add('hidden');
                ui.deletePatientBtn.classList.add('hidden');
            }
            ui.patientModal.style.display = 'flex';
        }
        function closePatientModal() { ui.patientModal.style.display = 'none'; }
        
        function renderPatientList() {
            ui.patientListEl.innerHTML = '';
            const sortedPatients = [...state.patients].sort((a,b) => a.surname.localeCompare(b.surname));

            if (sortedPatients.length === 0) {
                ui.patientListEl.innerHTML = `<div class="text-center p-4 text-gray-500">Nessun paziente.</div>`; return;
            }
            sortedPatients.forEach(patient => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer flex items-center space-x-3';
                div.innerHTML = `<div class="w-4 h-4 rounded-full" style="background-color: ${getPatientColor(patient.id)};"></div><p class="font-semibold">${patient.surname} ${patient.name}</p>`;
                div.addEventListener('click', () => openPatientModal(patient));
                ui.patientListEl.appendChild(div);
            });
            updateAppointmentPatientDatalist();
        }
        
        function updateAppointmentPatientDatalist() {
            const currentVal = ui.appointmentPatientSelect.value;
            ui.appointmentPatientSelect.innerHTML = '<option value="" disabled>Seleziona un paziente...</option>';
            const sortedPatients = [...state.patients].sort((a,b) => a.surname.localeCompare(b.surname));
            sortedPatients.forEach(p => {
                ui.appointmentPatientSelect.innerHTML += `<option value="${p.id}">${p.surname} ${p.name}</option>`;
            });
            ui.appointmentPatientSelect.value = currentVal;
            if (!ui.appointmentPatientSelect.value) { ui.appointmentPatientSelect.selectedIndex = 0; }
        }

        function changeWeek(days) { currentWeekStartDate = addDays(currentWeekStartDate, days); renderCalendar(); }
            
        function renderCalendar() {
            const weekRangeEl = document.getElementById('weekRange');
            const endDate = addDays(currentWeekStartDate, 6);
            weekRangeEl.textContent = `${formatDate(currentWeekStartDate, 'DD/MM')} - ${formatDate(endDate, 'DD/MM')}`;
            ui.calendarHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th class="p-2 sticky left-0 bg-white z-10 w-20">Orario</th>`;
            const daysOfWeek = ['L', 'M', 'M', 'G', 'V', 'S', 'D'];
            for (let i = 0; i < 7; i++) {
                const day = addDays(currentWeekStartDate, i);
                headerRow.innerHTML += `<th class="p-2 text-sm sm:text-base">${daysOfWeek[i]}<br><span class="font-normal text-xs sm:text-sm">${formatDate(day, 'DD/MM')}</span></th>`;
            }
            ui.calendarHead.appendChild(headerRow);
            ui.calendarBody.innerHTML = '';
            for (let t = 14 * 60; t < 20 * 60; t += 15) {
                const time = `${String(Math.floor(t / 60)).padStart(2, '0')}:${String(t % 60).padStart(2, '0')}`;
                const timeRow = document.createElement('tr');
                timeRow.innerHTML = `<td class="p-2 sticky left-0 bg-white z-10 font-mono text-xs sm:text-sm text-gray-600">${time}</td>`;
                for (let i = 0; i < 7; i++) {
                    const date = formatDate(addDays(currentWeekStartDate, i));
                    timeRow.innerHTML += `<td class="h-12" data-date="${date}" data-time="${time}"></td>`;
                }
                ui.calendarBody.appendChild(timeRow);
            }
            populateCalendar();
        }
            
        function populateCalendar() {
            document.querySelectorAll('td[data-date]').forEach(cell => {
                cell.className = 'h-12'; cell.removeAttribute('rowspan'); cell.style.display = '';
                cell.innerHTML = ''; cell.onclick = (e) => openAppointmentModal(e);
            });

            const startStr = formatDate(currentWeekStartDate);
            const endStr = formatDate(addDays(currentWeekStartDate, 6));
            const weekAppointments = state.appointments.filter(app => app.date >= startStr && app.date <= endStr);
            weekAppointments.sort((a,b) => a.time.localeCompare(b.time));

            weekAppointments.forEach(app => {
                const startCell = document.querySelector(`td[data-date="${app.date}"][data-time="${app.time}"]`);
                if (!startCell || startCell.style.display === 'none') return;
                const duration = parseInt(app.duration) || 60;
                const slots = duration / 15;
                startCell.setAttribute('rowspan', slots);
                startCell.className = 'appointment-cell';
                startCell.style.backgroundColor = getPatientColor(app.patientId);
                startCell.innerHTML = `<div class="p-1 text-xs font-semibold">${app.patientName}</div><div class="p-1 text-xs">${app.time} - ${app.price}€</div>`;
                startCell.onclick = () => openAppointmentModal(app);
                if (slots > 1) {
                    let nextCell = startCell.parentElement.nextElementSibling;
                    for (let i = 1; i < slots && nextCell; i++) {
                        const cellToHide = nextCell.querySelector(`td[data-date="${app.date}"]`);
                        if(cellToHide) cellToHide.style.display = 'none';
                        nextCell = nextCell.nextElementSibling;
                    }
                }
            });
            calculateWeeklyTotal(weekAppointments);
        }
            
        function calculateWeeklyTotal(appointments) {
            const total = appointments.reduce((sum, app) => sum + (Number(app.price) || 0), 0);
            document.getElementById('weeklyTotal').querySelector('p:last-child').textContent = `€ ${total.toFixed(2)}`;
        }

        function openAppointmentModal(appointmentOrEvent, preselectedPatient = null) {
            ui.appointmentForm.reset();
            ui.appointmentDurationInput.value = '60';
            ui.conflictError.classList.add('hidden');
            ui.deleteAppointmentBtn.classList.add('hidden');
            ui.recurringOptions.classList.add('hidden');
            ui.isRecurringCheckbox.checked = false;
            document.querySelectorAll('#weekdays input').forEach(c => { c.checked = false; c.parentElement.classList.remove('bg-teal-500', 'text-white'); });

            if (appointmentOrEvent && appointmentOrEvent.id) { // Existing appointment
                const app = appointmentOrEvent;
                ui.appointmentModalTitle.textContent = 'Modifica Appuntamento';
                ui.appointmentIdInput.value = app.id;
                ui.originalAppointmentDataInput.value = JSON.stringify(app);
                ui.appointmentPatientSelect.value = app.patientId;
                ui.appointmentPriceInput.value = app.price;
                ui.appointmentDateInput.value = app.date;
                ui.appointmentTimeInput.value = app.time;
                ui.appointmentDurationInput.value = app.duration || 60;
                ui.appointmentNotesInput.value = app.notes || '';
                ui.deleteAppointmentBtn.classList.remove('hidden');
                ui.isRecurringCheckbox.disabled = !!app.recurringId;
            } else { // New appointment
                ui.appointmentModalTitle.textContent = 'Nuovo Appuntamento';
                ui.appointmentIdInput.value = '';
                ui.isRecurringCheckbox.disabled = false;
                if (preselectedPatient) {
                     ui.appointmentPatientSelect.value = preselectedPatient.id;
                     ui.appointmentPriceInput.value = preselectedPatient.defaultPrice || '';
                } else if (appointmentOrEvent && appointmentOrEvent.target) {
                    const cell = appointmentOrEvent.target.closest('td[data-date]');
                    if (!cell) return;
                    ui.appointmentDateInput.value = cell.dataset.date;
                    ui.appointmentTimeInput.value = cell.dataset.time;
                }
            }
            ui.appointmentModal.style.display = 'flex';
        }
        function closeAppointmentModal() { ui.appointmentModal.style.display = 'none'; }
        
        async function handleAppointmentSubmit(e) {
            e.preventDefault();
            const appointmentId = ui.appointmentIdInput.value;
            const patientId = ui.appointmentPatientSelect.value;
            const patientName = ui.appointmentPatientSelect.options[ui.appointmentPatientSelect.selectedIndex].textContent;
            
            const appointmentData = {
                patientId, patientName,
                price: ui.appointmentPriceInput.value,
                notes: ui.appointmentNotesInput.value.trim(),
                date: ui.appointmentDateInput.value,
                time: ui.appointmentTimeInput.value,
                duration: ui.appointmentDurationInput.value || '60',
            };
            if (!patientId || !appointmentData.price || !appointmentData.date || !appointmentData.time) {
                alert('Paziente, prezzo, data e ora sono obbligatori.'); return;
            }

            if (appointmentId) {
                const originalAppointmentData = JSON.parse(ui.originalAppointmentDataInput.value);
                
                if (originalAppointmentData.recurringId) { // Editing an ALREADY recurring appointment
                    appointmentData.recurringId = originalAppointmentData.recurringId;
                    const action = await showRecurrenceConfirmModal('update');
                    if (action === 'cancel') return;
                    
                    if (action === 'single') {
                        if (await checkConflict(appointmentData, appointmentId)) { ui.conflictError.classList.remove('hidden'); return; }
                        state.appointments = state.appointments.map(a => a.id === appointmentId ? { ...a, ...appointmentData } : a);
                    } else if (action === 'all') {
                        if (!(await updateFutureRecurring(originalAppointmentData, appointmentData))) return;
                    }
                } else if(ui.isRecurringCheckbox.checked) { // Converting a SINGLE appointment to RECURRING
                    const newSeries = await generateRecurringAppointments(appointmentData, appointmentId);
                    if (!newSeries) return; // Conflict check failed
                    state.appointments = state.appointments.filter(a => a.id !== appointmentId);
                    state.appointments.push(...newSeries);
                }
                else { // Editing a SINGLE appointment (and keeping it single)
                    if (await checkConflict(appointmentData, appointmentId)) { ui.conflictError.classList.remove('hidden'); return; }
                    state.appointments = state.appointments.map(a => a.id === appointmentId ? { ...appointmentData, id: a.id } : a);
                }
            } else { // Creating a NEW appointment
                if (ui.isRecurringCheckbox.checked) {
                    const newSeries = await generateRecurringAppointments(appointmentData);
                    if(!newSeries) return;
                    state.appointments.push(...newSeries);
                } else {
                    if (await checkConflict(appointmentData)) { ui.conflictError.classList.remove('hidden'); return; }
                    appointmentData.id = crypto.randomUUID();
                    state.appointments.push(appointmentData);
                }
            }
            saveState();
            refreshUI();
            closeAppointmentModal();
        }

        async function handleDeleteAppointment() {
            const appointmentId = ui.appointmentIdInput.value;
            if (!appointmentId) return;
            const originalAppointmentData = JSON.parse(ui.originalAppointmentDataInput.value);

            const action = originalAppointmentData.recurringId ? await showRecurrenceConfirmModal('delete') : 'single';
            if (action === 'cancel') return;
            
            if (action === 'single') {
                state.appointments = state.appointments.filter(a => a.id !== appointmentId);
            } else if (action === 'all') {
                deleteFutureRecurring(originalAppointmentData);
            }
            
            saveState();
            refreshUI();
            closeAppointmentModal();
        }
            
        async function generateRecurringAppointments(baseAppointment, ignoreId = null) {
            const weeks = parseInt(ui.recurringWeeksInput.value);
            const selectedDays = Array.from(document.querySelectorAll('#weekdays input:checked')).map(c => parseInt(c.dataset.day));
            if (selectedDays.length === 0) { alert("Seleziona almeno un giorno per la ricorrenza."); return null; }
            
            const startDate = new Date(baseAppointment.date + 'T00:00:00');
            const recurringId = baseAppointment.recurringId || crypto.randomUUID();
            let appointmentsToAdd = [];
            for (let w = 0; w < weeks; w++) {
                for (const dayIndex of selectedDays) {
                    const mondayOfWeek = getMonday(addDays(startDate, w * 7));
                    const offset = dayIndex === 0 ? 6 : dayIndex - 1;
                    const dateForThisInstance = addDays(mondayOfWeek, offset);
                    
                    const newApp = { ...baseAppointment, date: formatDate(dateForThisInstance), recurringId, id: crypto.randomUUID() };
                    appointmentsToAdd.push(newApp);
                }
            }
            for (const app of appointmentsToAdd) {
                if (await checkConflict(app, ignoreId)) {
                    ui.conflictError.classList.remove('hidden');
                    alert(`Conflitto: ${app.date} ${app.time}.`); return null;
                }
            }
            return appointmentsToAdd;
        }

        async function updateFutureRecurring(originalData, newData) {
            const futureAppointments = state.appointments
                .filter(a => a.recurringId === originalData.recurringId && a.date >= originalData.date)
                .sort((a,b) => a.date.localeCompare(b.date));
                
            const otherAppointments = state.appointments.filter(a => a.recurringId !== originalData.recurringId || a.date < originalData.date);
            
            const originalDate = new Date(originalData.date);
            const newDate = new Date(newData.date);
            const utc1 = Date.UTC(originalDate.getFullYear(), originalDate.getMonth(), originalDate.getDate());
            const utc2 = Date.UTC(newDate.getFullYear(), newDate.getMonth(), newDate.getDate());
            const dayDifference = Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));

            const updatedFutureAppointments = futureAppointments.map(appToUpdate => {
                const currentInstanceDate = new Date(appToUpdate.date);
                const newDateForThisInstance = addDays(currentInstanceDate, dayDifference);
                
                return { 
                    ...appToUpdate, 
                    patientId: newData.patientId,
                    patientName: newData.patientName,
                    price: newData.price,
                    notes: newData.notes,
                    time: newData.time,
                    duration: newData.duration,
                    date: formatDate(newDateForThisInstance),
                };
            });

            for(const app of updatedFutureAppointments) {
                const otherAppsForCheck = [...otherAppointments, ...updatedFutureAppointments.filter(a => a.id !== app.id)];
                if (await checkConflict(app, app.id, otherAppsForCheck)) {
                    ui.conflictError.classList.remove('hidden');
                    alert(`Conflitto aggiornando la serie: ${app.date} ${app.time}. L'operazione è stata annullata.`);
                    return false;
                }
            }
            state.appointments = [...otherAppointments, ...updatedFutureAppointments];
            return true;
        }

        function deleteFutureRecurring(originalData) {
            state.appointments = state.appointments.filter(a => a.recurringId !== originalData.recurringId || a.date < originalData.date);
        }

        async function checkConflict(appData, ignoreId = null, appointmentList = state.appointments) {
            const duration = parseInt(appData.duration) || 60;
            const [startH, startM] = appData.time.split(':').map(Number);
            const startTime = startH * 60 + startM;
            const endTime = startTime + duration;
            
            const dayAppointments = appointmentList.filter(a => a.date === appData.date && a.id !== ignoreId);
            
            for(const existingApp of dayAppointments){
                const [existingStartH, existingStartM] = existingApp.time.split(':').map(Number);
                const existingStartTime = existingStartH * 60 + existingStartM;
                const existingEndTime = existingStartTime + (parseInt(existingApp.duration) || 60);
                if (startTime < existingEndTime && endTime > existingStartTime) return true;
            }
            return false;
        }

        async function confirmAction(title, message) {
            document.getElementById('confirmActionTitle').textContent = title;
            document.getElementById('confirmActionMessage').textContent = message;
            ui.confirmActionModal.style.display = 'flex';
            
            return new Promise((resolve) => {
                document.getElementById('confirmActionOk').onclick = () => {
                    ui.confirmActionModal.style.display = 'none';
                    resolve(true);
                };
                document.getElementById('confirmActionCancel').onclick = () => {
                    ui.confirmActionModal.style.display = 'none';
                    resolve(false);
                };
            });
        }
        
        async function handleDeletePatient() {
            const patientId = ui.patientIdInput.value;
            if (!patientId) return;

            const patient = state.patients.find(p => p.id === patientId);
            const confirmed = await confirmAction(
                'Conferma Eliminazione Paziente', 
                `Sei sicuro di voler eliminare ${patient.name} ${patient.surname}? Questa azione è permanente e cancellerà anche tutti i suoi appuntamenti.`
            );

            if (confirmed) {
                // Remove patient
                state.patients = state.patients.filter(p => p.id !== patientId);
                // Remove all appointments for that patient
                state.appointments = state.appointments.filter(app => app.patientId !== patientId);
                
                saveState();
                refreshUI();
                closePatientModal();
            }
        }


        function showRecurrenceConfirmModal(action) {
            const msgEl = document.getElementById('confirmRecurrenceMessage');
            const singleBtn = document.getElementById('confirmRecurrenceSingle');
            const allBtn = document.getElementById('confirmRecurrenceAll');
            document.getElementById('confirmRecurrenceTitle').textContent = action === 'delete' ? 'Conferma Eliminazione' : 'Conferma Modifica';
            msgEl.textContent = `Questo è un appuntamento ricorrente. Vuoi ${action === 'delete' ? 'eliminare' : 'modificare'} solo questa data o anche tutte le future?`;
            singleBtn.textContent = 'Solo questo appuntamento';
            allBtn.textContent = 'Tutti gli appuntamenti futuri';
            ui.confirmRecurrenceModal.style.display = 'flex';
            return new Promise((resolve) => {
                singleBtn.onclick = () => { ui.confirmRecurrenceModal.style.display = 'none'; resolve('single'); };
                allBtn.onclick = () => { ui.confirmRecurrenceModal.style.display = 'none'; resolve('all'); };
                document.getElementById('confirmRecurrenceCancel').onclick = () => { ui.confirmRecurrenceModal.style.display = 'none'; resolve('cancel'); };
            });
        }
        
        function handlePrint() {
            const weekRangeText = ui.weekRange.textContent;
            document.body.dataset.printTitle = `Riepilogo Settimana: ${weekRangeText}`;
            window.print();
        }

        function setupEventListeners() {
            ui.authorizeButton.onclick = handleAuthClick;
            ui.signoutButton.onclick = handleSignoutClick;
            document.getElementById('addPatientBtn').onclick = () => openPatientModal();
            document.getElementById('cancelPatientBtn').onclick = closePatientModal;
            document.getElementById('cancelAppointmentBtn').onclick = closeAppointmentModal;
            ui.deletePatientBtn.onclick = handleDeletePatient;
            document.getElementById('prevWeekBtn').onclick = () => changeWeek(-7);
            document.getElementById('nextWeekBtn').onclick = () => changeWeek(7);
            document.getElementById('todayBtn').onclick = () => { currentWeekStartDate = getMonday(new Date()); renderCalendar(); };
            ui.printWeekBtn.onclick = handlePrint;
            document.getElementById('addAppointmentFromPatientBtn').onclick = () => {
                const patient = state.patients.find(p => p.id === ui.patientIdInput.value);
                if (patient) { closePatientModal(); openAppointmentModal(null, patient); }
            };
            ui.patientForm.onsubmit = (e) => {
                e.preventDefault();
                const patientId = ui.patientIdInput.value;
                const patientData = {
                    id: patientId || crypto.randomUUID(),
                    name: ui.patientNameInput.value.trim(),
                    surname: ui.patientSurnameInput.value.trim(),
                    phone: ui.patientPhoneInput.value.trim(),
                    address: ui.patientAddressInput.value.trim(),
                    defaultPrice: ui.patientDefaultPriceInput.value.trim(),
                    notes: ui.patientNotesInput.value.trim()
                };
                if (!patientData.name || !patientData.surname) return;

                if (patientId) {
                    state.patients = state.patients.map(p => p.id === patientId ? patientData : p);
                } else {
                    state.patients.push(patientData);
                }
                saveState();
                refreshUI();
                closePatientModal();
            };
            ui.appointmentForm.onsubmit = handleAppointmentSubmit;
            ui.deleteAppointmentBtn.onclick = handleDeleteAppointment;
            ui.appointmentPatientSelect.onchange = (e) => {
                const patient = state.patients.find(p => p.id === e.target.value);
                if (patient && patient.defaultPrice) { ui.appointmentPriceInput.value = patient.defaultPrice; }
            };
            ui.isRecurringCheckbox.onchange = (e) => {
                ui.recurringOptions.classList.toggle('hidden', !e.target.checked);
            };
            document.querySelectorAll('#weekdays label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.preventDefault();
                    const checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('bg-teal-500', checkbox.checked);
                    this.classList.toggle('text-white', checkbox.checked);
                });
            });
            ui.togglePatientListBtn.addEventListener('click', () => {
                ui.patientSidebar.classList.toggle('-translate-x-full');
                ui.sidebarBackdrop.classList.toggle('hidden');
            });
            ui.sidebarBackdrop.addEventListener('click', () => {
                ui.patientSidebar.classList.add('-translate-x-full');
                ui.sidebarBackdrop.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
